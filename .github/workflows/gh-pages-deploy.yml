name: Deploy to GitHub Pages

on:
  push:
    branches: [ production, main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    concurrency:
      group: gh-pages-deploy
      cancel-in-progress: true
    permissions:
      contents: write
      pages: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: "npm"
      - name: Cache Node Modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            ${{ github.workspace }}/.next/cache
            node_modules
          # Generate a new cache whenever packages or key source files change.
          key: ${{ runner.os }}-nextjs-${{ hashFiles('package-lock.json','package.json','next.config.ts','**/*.js','**/*.jsx','**/*.ts','**/*.tsx') }}
          # If source files changed but packages didn't, try broader fallbacks.
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('package-lock.json','package.json') }}-
            ${{ runner.os }}-nextjs-
      - name: Install dependencies
        run: |
          set -ex
          npm ci

      - name: Validate required secrets
        run: |
          set -e
          echo "Checking required repository secrets (values hidden)..."
          MISSING=0
          check() {
            if [ -z "${1}" ]; then
              echo "✖ ${2}: MISSING" >&2
              MISSING=1
            else
              echo "✔ ${2}: PRESENT"
            fi
          }
          check "${{ secrets.NEXT_PUBLIC_GA_ID }}" NEXT_PUBLIC_GA_ID
          check "${{ secrets.NEXT_PUBLIC_GA_MEASUREMENT_ID }}" NEXT_PUBLIC_GA_MEASUREMENT_ID
          check "${{ secrets.NEXT_PUBLIC_GTM_ID }}" NEXT_PUBLIC_GTM_ID
          check "${{ secrets.NEXT_PUBLIC_SITE_URL }}" NEXT_PUBLIC_SITE_URL
          check "${{ secrets.GA_CLIENT_EMAIL }}" GA_CLIENT_EMAIL
          check "${{ secrets.GA_PRIVATE_KEY }}" GA_PRIVATE_KEY
          check "${{ secrets.GA_VIEW_ID }}" GA_VIEW_ID
          check "${{ secrets.GA_PROPERTY_ID }}" GA_PROPERTY_ID
          check "${{ secrets.ANALYTICS_BACKEND }}" ANALYTICS_BACKEND
          if [ "$MISSING" -eq 1 ]; then
            echo "One or more required secrets are missing. Set them in repository Settings → Secrets → Actions." >&2
            exit 1
          fi
      - name: Build SCSS
        run: |
          set -ex
          npm run scss:build
      - name: Build (static export) and capture logs
        env:
          NEXT_STATIC_EXPORT: 'true'
        run: |
          set -eo pipefail
          mkdir -p logs
          echo "Starting Next.js build (logs -> logs/build.log)"
          # Capture full build output to logs/build.log
          if npm run build 2>&1 | tee logs/build.log; then
            echo "Build succeeded"
          else
            echo "Build failed — showing tail of logs and uploading artifact in later step"
            echo "==== Build log (tail 200) ===="
            tail -n 200 logs/build.log || true
            # Exit with non-zero so subsequent 'if: failure()' steps run
            exit 1
          fi
      - name: Prevent Jekyll processing on GitHub Pages
        run: |
          set -ex
          # Create a .nojekyll file so GitHub Pages doesn't run Jekyll on the published site
          mkdir -p out
          echo > out/.nojekyll
      - name: Print build log tail (on failure)
        if: failure()
        run: |
          echo "==== Build log (tail 500) ===="
          ls -la logs || true
          tail -n 500 logs/build.log || true

      - name: Upload build logs artifact (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: logs/build.log
      - name: Ensure GitHub Pages source is gh-pages root (uses `PERSONAL_ACCESS_TOKEN`)
        env:
          PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          set -ex
          if [ -z "$PERSONAL_ACCESS_TOKEN" ]; then
            echo "No personal access token found in secret 'PERSONAL_ACCESS_TOKEN'. Skipping automatic Pages configuration."
            echo "If you want automatic configuration, add a PAT with 'pages:write' or 'repo' scope as repository secret 'PERSONAL_ACCESS_TOKEN'."
            exit 0
          fi
          OWNER=$(echo "$GITHUB_REPOSITORY" | cut -d'/' -f1)
          REPO=$(echo "$GITHUB_REPOSITORY" | cut -d'/' -f2)
          PAYLOAD='{"source":{"branch":"gh-pages","path":"/"}}'
          HTTP_CODE=$(curl -s -w "%{http_code}" -o /tmp/pages_response.json -X PUT \
            -H "Authorization: token $PERSONAL_ACCESS_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/$OWNER/$REPO/pages \
            -d "$PAYLOAD" ) || true
          echo "GitHub Pages API HTTP status: $HTTP_CODE"
          echo "Response body:" && cat /tmp/pages_response.json || true
          if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "204" ] || [ "$HTTP_CODE" = "200" ]; then
            echo "GitHub Pages source configured to gh-pages branch root."
          else
            echo "Warning: could not configure GitHub Pages source (HTTP $HTTP_CODE)." >&2
            echo "Please set Pages source to 'gh-pages' branch root in Settings → Pages if this fails." >&2
            echo "Continuing deployment — this step will not fail the workflow." >&2
          fi
      # - name: Build (static export) + generate analytics
      #   env:
      #     NEXT_STATIC_EXPORT: 'true'
      #     # Provide GA/GTM and public site config from repo secrets so
      #     # the layout's env-driven script blocks render in the generated HTML.
      #     NEXT_PUBLIC_GA_ID: ${{ secrets.NEXT_PUBLIC_GA_ID }}
      #     NEXT_PUBLIC_GA_MEASUREMENT_ID: ${{ secrets.NEXT_PUBLIC_GA_MEASUREMENT_ID }}
      #     NEXT_PUBLIC_GTM_ID: ${{ secrets.NEXT_PUBLIC_GTM_ID }}
      #     NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL }}
      #     # Include compiled SCSS in CI static export (matches local .env behavior)
      #     NEXT_PUBLIC_INCLUDE_SCSS: 'true'
      #     # Secrets required to run the analytics generator script
      #     GA_CLIENT_EMAIL: ${{ secrets.GA_CLIENT_EMAIL }}
      #     GA_PRIVATE_KEY: ${{ secrets.GA_PRIVATE_KEY }}
      #     GA_VIEW_ID: ${{ secrets.GA_VIEW_ID }}
      #     GA_PROPERTY_ID: ${{ secrets.GA_PROPERTY_ID }}
      #     ANALYTICS_BACKEND: ${{ secrets.ANALYTICS_BACKEND }}
      #   run: |
      #     set -ex
      #     npm run build
      #     npm run generate:analytics
      - name: Deploy `out/` to `gh-pages` branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./out
          publish_branch: gh-pages
          user_name: github-actions
          user_email: github-actions@users.noreply.github.com
          cname: sanatanadharmam.in