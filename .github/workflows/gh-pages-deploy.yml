name: Deploy to GitHub Pages

on:
  push:
    branches: [ production ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    concurrency:
      group: gh-pages-deploy
      cancel-in-progress: true
    permissions:
      contents: write
      pages: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: "npm"
      - name: Cache Node Modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            ${{ github.workspace }}/.next/cache
            node_modules
          # Generate a new cache whenever packages or source files change.
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx') }}
          # If source files changed but packages didn't, rebuild from a prior cache.
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-          
      - name: Install dependencies
        run: |
          set -ex
          npm ci

      - name: Validate required secrets
        run: |
          set -e
          echo "Checking required repository secrets (values hidden)..."
          MISSING=0
          check() {
            if [ -z "${1}" ]; then
              echo "✖ ${2}: MISSING" >&2
              MISSING=1
            else
              echo "✔ ${2}: PRESENT"
            fi
          }
          check "${{ secrets.NEXT_PUBLIC_GA_ID }}" NEXT_PUBLIC_GA_ID
          check "${{ secrets.NEXT_PUBLIC_GA_MEASUREMENT_ID }}" NEXT_PUBLIC_GA_MEASUREMENT_ID
          check "${{ secrets.NEXT_PUBLIC_GTM_ID }}" NEXT_PUBLIC_GTM_ID
          check "${{ secrets.NEXT_PUBLIC_SITE_URL }}" NEXT_PUBLIC_SITE_URL
          check "${{ secrets.GA_CLIENT_EMAIL }}" GA_CLIENT_EMAIL
          check "${{ secrets.GA_PRIVATE_KEY }}" GA_PRIVATE_KEY
          check "${{ secrets.GA_VIEW_ID }}" GA_VIEW_ID
          check "${{ secrets.GA_PROPERTY_ID }}" GA_PROPERTY_ID
          check "${{ secrets.ANALYTICS_BACKEND }}" ANALYTICS_BACKEND
          if [ "$MISSING" -eq 1 ]; then
            echo "One or more required secrets are missing. Set them in repository Settings → Secrets → Actions." >&2
            exit 1
          fi
      - name: Build SCSS
        run: |
          set -ex
          npm run scss:build
      # - name: Build (static export) + generate analytics
      #   env:
      #     NEXT_STATIC_EXPORT: 'true'
      #     # Provide GA/GTM and public site config from repo secrets so
      #     # the layout's env-driven script blocks render in the generated HTML.
      #     NEXT_PUBLIC_GA_ID: ${{ secrets.NEXT_PUBLIC_GA_ID }}
      #     NEXT_PUBLIC_GA_MEASUREMENT_ID: ${{ secrets.NEXT_PUBLIC_GA_MEASUREMENT_ID }}
      #     NEXT_PUBLIC_GTM_ID: ${{ secrets.NEXT_PUBLIC_GTM_ID }}
      #     NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL }}
      #     # Include compiled SCSS in CI static export (matches local .env behavior)
      #     NEXT_PUBLIC_INCLUDE_SCSS: 'true'
      #     # Secrets required to run the analytics generator script
      #     GA_CLIENT_EMAIL: ${{ secrets.GA_CLIENT_EMAIL }}
      #     GA_PRIVATE_KEY: ${{ secrets.GA_PRIVATE_KEY }}
      #     GA_VIEW_ID: ${{ secrets.GA_VIEW_ID }}
      #     GA_PROPERTY_ID: ${{ secrets.GA_PROPERTY_ID }}
      #     ANALYTICS_BACKEND: ${{ secrets.ANALYTICS_BACKEND }}
      #   run: |
      #     set -ex
      #     npm run build
      #     npm run generate:analytics
      - name: Deploy `out/` to `gh-pages` branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./out
          publish_branch: gh-pages
          user_name: github-actions
          user_email: github-actions@users.noreply.github.com
          cname: sanatanadharmam.in